{% extends "core/base.html" %}
{% load humanize %}
{% block title %}Student Dashboard{% endblock %}

{% block content %}
<div class="bg-gray-50 min-h-screen p-6">

  <!-- ================= HEADER ================= -->
  <div class="flex justify-between items-center mb-8">
    <div>
      <h1 class="text-2xl font-bold">
        Welcome back,
        {{ request.user.full_name|default:request.user.username }}
      </h1>
      <p class="text-gray-500">Your learning dashboard</p>
    </div>

    <button onclick="openSearch()"
            class="flex items-center gap-2 px-4 py-2 border rounded-xl
                  text-gray-500 hover:bg-gray-50">
      üîç Search students / teachers
    </button>

  </div>

  <div class="grid grid-cols-12 gap-6">

    <!-- ================= LEFT COLUMN ================= -->
    <div class="col-span-4 space-y-6">

      <!-- PROFILE CARD -->
      <div class="bg-white rounded-xl shadow p-6 space-y-4">
        <div class="flex justify-between items-start">
          <img
            src="{{ request.user.avatar_url }}"
            class="w-16 h-16 rounded-full object-cover"
            alt="Avatar"
          />

          <button
            type="button"
            onclick="openProfileModal()"
            class="flex items-center gap-2
                  px-4 py-2 border rounded-full
                  text-sm font-medium text-gray-700
                  hover:bg-gray-50">
            ‚úèÔ∏è <span>Edit</span>
          </button>

        </div>

        <div>
          <h2 class="text-lg font-semibold">
            {{ request.user.full_name|default:request.user.username }}
          </h2>
        </div>

        <ul class="text-sm text-gray-600 space-y-1">
          {% if request.user.location %}
            <li>üìç {{ request.user.location }}</li>
          {% endif %}
          <li>üìÖ Joined {{ request.user.date_joined|date:"F Y" }}</li>
          <li>üéì {{ enrolled_count }} Enrolled Courses</li>
        </ul>
      </div>

      <!-- UPCOMING DEADLINES -->
      <div class="bg-white rounded-xl shadow p-6">

        <!-- Header -->
        <div class="flex justify-between items-center mb-4">

          <h2 class="text-lg font-semibold flex items-center gap-2">
            ‚è∞ Upcoming Deadlines
          </h2>

          <a href="{% if show_past %}?{% else %}?show_past=1{% endif %}"
            class="inline-flex items-center gap-1.5
                    px-3 py-1
                    text-xs font-medium
                    rounded-full
                    border border-gray-300
                    text-gray-600
                    hover:border-gray-400
                    hover:bg-gray-50
                    transition">

            {% if show_past %}
              <span class="text-gray-400">‚úï</span>
              <span>Hide past</span>
            {% else %}
              <span class="text-gray-400">‚è≥</span>
              <span>Show past</span>
            {% endif %}

          </a>
        </div>

        <!-- Deadlines list -->
        {% for d in deadlines %}
          <div class="py-4 border-b border-dashed border-gray-200 last:border-b-0">

            <div class="flex justify-between items-start">
              <div>
                <p class="font-semibold text-sm">
                  {{ d.title }}
                </p>

                <p class="text-sm text-gray-600 flex items-center gap-2">
                  {{ d.course.title }}
                </p>

                <p class="text-sm text-gray-500 flex items-center gap-1 mt-1">
                  üïí {{ d.due_at|date:"M d, Y" }} | {{ d.due_at|date:"h:i A" }}
                </p>
              </div>

              {% if d.status == "due" %}
                <span class="px-3 py-1 text-xs rounded-full bg-red-100 text-red-700">
                  Due
                </span>
              {% elif d.status == "due_soon" %}
                <span class="px-3 py-1 text-xs rounded-full bg-orange-100 text-orange-700">
                  Due Soon
                </span>
              {% else %}
                <span class="px-3 py-1 text-xs rounded-full bg-gray-100 text-gray-600">
                  Upcoming
                </span>
              {% endif %}
            </div>

          </div>

        {% empty %}
          <p class="text-sm text-gray-400">
            No upcoming deadlines üéâ
          </p>
        {% endfor %}
      </div>
    </div>

    <!-- ================= RIGHT COLUMN ================= -->
    <div class="col-span-8">

      <!-- TABS -->
      <div class="mb-6 flex gap-6 border-b">
        <a href="?tab=courses"
           class="pb-2 {% if tab == 'courses' %}
                    border-b-2 border-blue-600 text-blue-600
                    {% else %} text-gray-500 {% endif %}">
          My Courses
        </a>

        <a href="?tab=all"
           class="pb-2 {% if tab == 'all' %}
                    border-b-2 border-blue-600 text-blue-600
                    {% else %} text-gray-500 {% endif %}">
          All Courses
        </a>

        <a href="?tab=status"
           class="pb-2 {% if tab == 'status' %}
                    border-b-2 border-blue-600 text-blue-600
                    {% else %} text-gray-500 {% endif %}">
          Status Updates
        </a>
      </div>

      <!-- ================= MY COURSES ================= -->
      {% if tab == "courses" %}
        <div class="grid grid-cols-2 gap-6">
          {% for course in courses %}
            <div class="bg-white rounded-xl shadow p-6 space-y-4">

              <h3 class="font-semibold text-lg">{{ course.title }}</h3>

              {% if course.teachers %}
                <p class="text-sm text-gray-500">
                  Prof.
                  {% for t in course.teachers %}
                    {{ t.full_name|default:t.username }}{% if not forloop.last %}, {% endif %}
                  {% endfor %}
                </p>
              {% else %}
                <p class="text-sm text-gray-400">Instructor TBA</p>
              {% endif %}

              <!-- Progress -->
              <div class="space-y-1">
                <div class="flex justify-between text-sm text-gray-600">
                  <span>Progress</span>
                  <span>{{ course.progress }}%</span>
                </div>
                <div class="h-2 bg-gray-200 rounded-full">
                  <div class="h-2 bg-blue-600 rounded-full"
                       style="width: {{ course.progress }}%"></div>
                </div>
              </div>

              <div class="flex gap-3 pt-2">
                <a
                  href="{% url 'courses:course_continue' course.id %}"
                  class="flex-1 flex items-center justify-center
                         px-4 py-2 border rounded-lg
                         hover:bg-gray-50">
                  ‚ñ∂ Continue
                </a>

                <button
                  type="button"
                  onclick="openFeedbackModal(
                    '{{ course.title|escapejs }}',
                    '{% url 'courses:course_feedback' course.id %}',
                    {{ course.feedback_rating|default:0 }},
                    `{{ course.feedback_comment|escapejs }}`
                  )"
                  class="w-10 h-10 border rounded-lg
                        flex items-center justify-center
                        hover:bg-gray-50"
                  title="Leave feedback">
                  üí¨
                </button>

              </div>
            </div>
          {% empty %}
            <p class="text-gray-400">No enrolled courses yet.</p>
          {% endfor %}
        </div>
      {% endif %}

      <!-- ================= ALL COURSES ================= -->
      {% if tab == "all" %}
        <div class="grid grid-cols-2 gap-6">
          {% for course in all_courses %}
            <div class="bg-white rounded-xl shadow p-6 space-y-4">

              <div class="flex justify-between items-start">
                <div>
                  <h3 class="font-semibold text-lg">{{ course.title }}</h3>

                  {% if course.teachers %}
                    <p class="text-sm text-gray-500">
                      Prof.
                      {% for t in course.teachers %}
                        {{ t.full_name|default:t.username }}{% if not forloop.last %}, {% endif %}
                      {% endfor %}
                    </p>
                  {% else %}
                    <p class="text-sm text-gray-400">Instructor TBA</p>
                  {% endif %}
                </div>

                {% if course.is_enrolled %}
                  <span class="px-3 py-1 text-sm rounded-lg
                               bg-green-100 text-green-700">
                    Active
                  </span>
                {% else %}
                  <span class="px-3 py-1 text-sm rounded-lg
                               bg-gray-100 text-gray-600">
                    Not Enrolled
                  </span>
                {% endif %}
              </div>

              <div class="flex gap-3 pt-2">
                {% if course.is_enrolled %}
                  <a
                    href="{% url 'courses:course_continue' course.id %}"
                    class="flex-1 flex items-center justify-center
                           px-4 py-2 border rounded-lg
                           hover:bg-gray-50">
                    ‚ñ∂ Continue
                  </a>
                {% else %}
                  <form method="post"
                        action="{% url 'courses:course_enroll' course.id %}"
                        class="flex-1">
                    {% csrf_token %}
                    <button
                      type="submit"
                      class="w-full px-4 py-2
                             bg-blue-600 text-white
                             rounded-lg hover:bg-blue-700">
                      ‚ûï Enroll
                    </button>
                  </form>
                {% endif %}

                {% if course.is_enrolled %}
                  <button
                    type="button"
                    onclick="openFeedbackModal(
                      '{{ course.title|escapejs }}',
                      '{% url 'courses:course_feedback' course.id %}',
                      {{ course.feedback_rating|default:0 }},
                      `{{ course.feedback_comment|escapejs }}`
                    )"
                    class="w-10 h-10 border rounded-lg
                          flex items-center justify-center
                          hover:bg-gray-50"
                    title="Leave feedback">
                    üí¨
                  </button>
                {% else %}
                  <button
                    type="button"
                    disabled
                    class="w-10 h-10 border rounded-lg
                          flex items-center justify-center
                          text-gray-300 cursor-not-allowed"
                    title="Enroll to leave feedback">
                    üí¨
                  </button>
                {% endif %}

              </div>
            </div>
          {% endfor %}
        </div>
      {% endif %}

      <!-- ================= STATUS UPDATES ================= -->
      {% if tab == "status" %}
        <form method="post" class="flex gap-4 mb-8">
          {% csrf_token %}
          <div class="w-12 h-12 rounded-full bg-gray-300"></div>
          <div class="flex-1">
            {{ form.content }}
            <div class="flex justify-end mt-3">
              <button class="bg-blue-600 text-white px-5 py-2 rounded-xl">
                Post Update
              </button>
            </div>
          </div>
        </form>

        <div class="space-y-6">
          {% for update in updates %}
            <div class="bg-white rounded-xl shadow p-4">
              <p class="font-semibold">
                {{ update.author.full_name|default:update.author.username }}
              </p>
              <p class="mt-2">{{ update.content }}</p>
              <p class="text-xs text-gray-400">
                {{ update.created_at|naturaltime }}
              </p>
            </div>
          {% endfor %}
        </div>
      {% endif %}
    </div>
  </div>
</div>

<!-- ================= PROFILE EDIT MODAL ================= -->
<div id="profileModal"
     class="fixed inset-0 bg-black/40 hidden
            flex items-center justify-center z-50">

  <div class="bg-white rounded-xl w-full max-w-xl p-6 relative">

    <!-- Header -->
    <div class="flex justify-between items-start mb-4">
      <div>
        <h2 class="text-xl font-semibold">Personal details</h2>
        <p class="text-sm text-gray-500">
          Add your personal details as you would like it to appear on your profile.
        </p>
      </div>

      <button onclick="closeProfileModal()"
              aria-label="Close"
              class="text-gray-400 hover:text-gray-600 text-xl">
        √ó
      </button>
    </div>

    <form method="post" enctype="multipart/form-data">
      {% csrf_token %}

      <div class="space-y-6">

        <!-- ================= PROFILE PHOTO ================= -->
        <div>
          <label class="block text-sm font-medium mb-2">
            Profile Photo
          </label>

          <div class="flex flex-col items-start gap-4">

            <!-- Avatar Preview -->
            <div
              class="w-40 h-40 rounded-full border-2 border-gray-200
                     flex items-center justify-center overflow-hidden
                     bg-gray-100">

              {% if request.user.profile_photo %}
                <img
                  id="profilePhotoPreview"
                  src="{{ request.user.avatar_url }}"
                  alt="Profile photo"
                  class="w-full h-full object-cover"
                />
              {% else %}
                <div
                  id="profilePhotoPreview"
                  class="w-full h-full bg-blue-700
                         flex items-center justify-center
                         text-white text-5xl font-semibold">
                  {{ request.user.full_name|default:request.user.username|first }}
                </div>
              {% endif %}
            </div>

            <!-- Upload Button -->
            <label
              for="profilePhotoInput"
              class="inline-block bg-blue-600 text-white
                     px-5 py-2 rounded-lg cursor-pointer
                     hover:bg-blue-700 text-sm font-medium">
              Upload photo
            </label>

            <input
              id="profilePhotoInput"
              type="file"
              name="profile_photo"
              accept="image/*"
              onchange="previewProfilePhoto(event)"
              class="hidden"
            />

            <p class="text-sm text-gray-500">
              Maximum size: 1MB. Supported formats: JPG, GIF, or PNG.
            </p>
          </div>
        </div>

        <!-- ================= FULL NAME ================= -->
        <div>
          <label class="block text-sm font-medium mb-1">
            First and last name <span class="text-red-500">*</span>
          </label>
          <input type="text"
                 name="full_name"
                 required
                 value="{{ request.user.full_name }}"
                 class="w-full border rounded-lg p-2">
        </div>

        <!-- ================= EMAIL ================= -->
        <div>
          <label class="block text-sm font-medium mb-1">Email</label>
          <input type="email"
                 name="email"
                 value="{{ request.user.email }}"
                 class="w-full border rounded-lg p-2">
        </div>

        <!-- ================= LOCATION ================= -->
        <div>
          <label class="block text-sm font-medium mb-1">Location</label>
          <input type="text"
                 name="location"
                 value="{{ request.user.location|default_if_none:'' }}"
                 placeholder="e.g. Ho Chi Minh City, Vietnam"
                 class="w-full border rounded-lg p-2">
        </div>

        <!-- ================= BIO ================= -->
        <div>
          <label class="block text-sm font-medium mb-1">Bio</label>
          <textarea name="bio"
                    rows="3"
                    class="w-full border rounded-lg p-2"
                    placeholder="Tell us a little about yourself">{{ request.user.bio }}</textarea>
        </div>

      </div>

      <!-- Footer -->
      <div class="flex justify-end gap-3 mt-6">
        <button type="button"
                onclick="closeProfileModal()"
                class="px-4 py-2 border rounded-lg">
          Cancel
        </button>
        <button type="submit"
                class="px-6 py-2 bg-blue-600 text-white rounded-lg">
          Save changes
        </button>
      </div>

    </form>

  </div>
</div>


<!-- ================= FEEDBACK MODAL ================= -->
<div id="feedbackModal"
     class="fixed inset-0 bg-black/40 hidden
            flex items-center justify-center z-50">

  <div class="bg-white rounded-xl w-full max-w-lg p-6 relative">

    <div class="flex justify-between items-start mb-4">
      <div>
        <h2 class="text-xl font-semibold">Leave Feedback</h2>
        <p id="feedbackCourseTitle" class="text-gray-500 text-sm"></p>
      </div>

      <button onclick="closeFeedbackModal()"
              class="text-gray-400 hover:text-gray-600 text-xl">
        √ó
      </button>
    </div>

    <form method="post" id="feedbackForm">
      {% csrf_token %}
      <input type="hidden" name="rating" id="ratingInput" value="">

      <p class="font-medium mb-2">How would you rate this course?</p>

      <div class="flex gap-2 text-3xl text-gray-300 cursor-pointer mb-4">
        {% for i in "12345" %}
          <span onclick="setRating({{ forloop.counter }})"
                id="star{{ forloop.counter }}">‚òÖ</span>
        {% endfor %}
      </div>

      <label class="font-medium block mb-1">
        Additional Comments (Optional)
      </label>
      <textarea
        name="comment"
        class="w-full border rounded-lg p-3 mb-6"
        rows="4"
        placeholder="Share your thoughts about the course, instructor, or learning experience..."></textarea>

      <div class="flex justify-end gap-3">
        <button type="button"
                onclick="closeFeedbackModal()"
                class="px-4 py-2 border rounded-lg">
          Cancel
        </button>
        <button type="submit"
                id="submitFeedbackBtn"
                disabled
                class="px-6 py-2 bg-blue-600 text-white rounded-lg disabled:opacity-50">
          Submit Feedback
        </button>
      </div>
    </form>
  </div>
</div>

<!-- ================= SEARCH MODAL ================= -->
<div id="searchModal" class="fixed inset-0 z-50 hidden">

  <!-- Overlay -->
  <div class="absolute inset-0 bg-black/30" onclick="closeSearch()"></div>

  <!-- Side panel -->
  <div class="absolute right-0 top-0 h-full w-full max-w-md bg-white shadow-xl flex flex-col">

    <!-- ===== SEARCH VIEW ===== -->
    <div id="searchView" class="flex flex-col h-full">

      <!-- Header -->
      <div class="flex justify-between items-center px-6 py-4 border-b">
        <h2 class="text-lg font-semibold">Search</h2>
        <button onclick="closeSearch()" class="text-xl text-gray-400">√ó</button>
      </div>

      <!-- Tabs -->
      <div class="flex gap-2 px-6 py-3">
        <button id="tabStudent"
                onclick="setSearchRole('student')"
                class="flex-1 py-2 rounded-xl bg-blue-600 text-white font-medium">
          üéì Students
        </button>
        <button id="tabTeacher"
                onclick="setSearchRole('teacher')"
                class="flex-1 py-2 rounded-xl bg-gray-100 text-gray-600 font-medium">
          üë§ Teachers
        </button>
      </div>

      <!-- Input -->
      <div class="px-6">
        <input id="searchInput"
              type="text"
              placeholder="Search..."
              class="w-full border rounded-xl px-4 py-3"
              oninput="searchUsers()" />
      </div>

      <!-- Results -->
      <div id="searchResults"
          class="flex-1 overflow-y-auto px-6 py-4 space-y-3">
      </div>
    </div>

    <!-- ===== PROFILE VIEW ===== -->
    <div id="profileView" class="hidden flex flex-col h-full">

      <!-- Header -->
      <div class="flex items-center gap-3 px-6 py-4 border-b">
        <button onclick="backToSearch()" class="text-xl">‚Üê</button>
        <h2 class="text-lg font-semibold">Profile</h2>
      </div>

      <!-- Profile content -->
      <div class="flex-1 overflow-y-auto">

        <!-- Gradient -->
        <div class="h-32 bg-gradient-to-r from-blue-500 to-purple-500"></div>

        <!-- Avatar -->
        <div class="-mt-12 flex justify-center">
          <img id="profileAvatar"
              class="w-24 h-24 rounded-full object-cover border-4 border-white"
              src="" />
        </div>

        <div class="p-6 text-center">
          <h2 id="profileName" class="text-xl font-bold"></h2>
          <p id="profileRole" class="text-gray-500"></p>

          <p id="profileBio" class="text-sm text-gray-600 mt-4"></p>

          <!-- Contact -->
          <div class="mt-6 bg-gray-50 rounded-xl p-4 text-left space-y-2">
            <p><strong>Email:</strong> <span id="profileEmail"></span></p>
            <p><strong>Location:</strong> <span id="profileLocation"></span></p>
            <p><strong>Member since:</strong> <span id="profileJoined"></span></p>
          </div>

          <!-- Stats -->
          <div id="profileStats"
              class="mt-4 bg-blue-50 rounded-xl p-4 hidden text-center">
            <span class="text-2xl font-bold" id="profileCourses"></span><br>
            Enrolled Courses
          </div>

          <!-- Chat button -->
          <button
            class="mt-6 w-full bg-blue-600 text-white py-3 rounded-xl hover:bg-blue-700">
            üí¨ Chat
          </button>
        </div>
      </div>
    </div>
  </div>

</div>


<div id="profileModal"
     class="fixed inset-0 bg-black/40 hidden z-50 flex justify-center items-center">

  <div class="bg-white rounded-2xl w-full max-w-md shadow-xl relative">

    <!-- Gradient header -->
    <div class="h-32 bg-gradient-to-r from-blue-500 to-purple-500 rounded-t-2xl relative">
      <button onclick="closeProfileModal()"
              class="absolute top-4 right-4 text-white text-xl">‚úï</button>
    </div>

    <!-- Avatar -->
    <div class="-mt-12 flex justify-center">
      <div class="w-24 h-24 bg-white rounded-full flex items-center justify-center shadow">
        <img id="profileAvatar"
             class="w-20 h-20 rounded-full object-cover"
             src=""
             alt="avatar">
      </div>
    </div>

    <!-- Content -->
    <div class="p-6 text-center">
      <h2 id="profileName" class="text-xl font-bold"></h2>
      <p id="profileRole" class="text-gray-500"></p>

      <p id="profileBio" class="text-sm text-gray-600 mt-4"></p>

      <!-- Contact -->
      <div class="mt-6 bg-gray-50 rounded-xl p-4 text-left space-y-2">
        <p><strong>Email:</strong> <span id="profileEmail"></span></p>
        <p><strong>Location:</strong> <span id="profileLocation"></span></p>
        <p><strong>Member since:</strong> <span id="profileJoined"></span></p>
      </div>

      <!-- Stats -->
      <div id="profileStats"
           class="mt-4 bg-blue-50 rounded-xl p-4 hidden">
        <p class="text-center">
          <span class="text-2xl font-bold" id="profileCourses"></span><br>
          Enrolled Courses
        </p>
      </div>
    </div>
  </div>
</div>

<script>
function openUserProfile(userId) {
  fetch(`/accounts/profile/${userId}/`)
    .then(res => {
      if (!res.ok) throw new Error("Profile not found");
      return res.json();
    })
    .then(data => {
      // switch views
      document.getElementById("searchView").classList.add("hidden");
      document.getElementById("profileView").classList.remove("hidden");

      // fill data
      document.getElementById("profileName").innerText = data.full_name;
      document.getElementById("profileRole").innerText = data.role;
      document.getElementById("profileEmail").innerText = data.email;
      document.getElementById("profileLocation").innerText = data.location || "‚Äî";
      document.getElementById("profileJoined").innerText = data.joined;
      document.getElementById("profileBio").innerText = data.bio || "";

      document.getElementById("profileAvatar").src =
        data.avatar || "/static/img/default-avatar.png";

      if (data.enrolled_courses !== null) {
        document.getElementById("profileStats").classList.remove("hidden");
        document.getElementById("profileCourses").innerText =
          data.enrolled_courses;
      } else {
        document.getElementById("profileStats").classList.add("hidden");
      }
    })
    .catch(() => alert("Unable to load profile"));
}

function backToSearch() {
  document.getElementById("profileView").classList.add("hidden");
  document.getElementById("searchView").classList.remove("hidden");
}
</script>



<script>
  function openFeedbackModal(courseTitle, actionUrl, rating, comment) {
    // show modal
    document.getElementById("feedbackModal").classList.remove("hidden");
    document.getElementById("feedbackCourseTitle").innerText = courseTitle;
    document.getElementById("feedbackForm").action = actionUrl;

    // reset state
    document.getElementById("ratingInput").value = "";
    document.getElementById("submitFeedbackBtn").disabled = true;

    // reset stars
    for (let i = 1; i <= 5; i++) {
      document.getElementById("star" + i).style.color = "#d1d5db";
    }

    // prefill comment
    document.querySelector(
      "#feedbackForm textarea[name='comment']"
    ).value = comment || "";

    // prefill rating ONLY through setRating
    if (rating && rating > 0) {
      setRating(rating);
    }
  }

  function closeFeedbackModal() {
    document.getElementById("feedbackModal").classList.add("hidden");
  }

  function setRating(value) {
    document.getElementById("ratingInput").value = value;

    for (let i = 1; i <= 5; i++) {
      document.getElementById("star" + i).style.color =
        i <= value ? "#2563eb" : "#d1d5db";
    }

    // enable submit ONLY here
    document.getElementById("submitFeedbackBtn").disabled = false;
  }
</script>


<script>
  function openProfileModal() {
    document.getElementById("profileModal").classList.remove("hidden");
  }

  function closeProfileModal() {
    document.getElementById("profileModal").classList.add("hidden");
  }

  function previewProfilePhoto(event) {
    const preview = document.getElementById("profilePhotoPreview");
    const file = event.target.files[0];

    if (!file) return;

    if (file.size > 1024 * 1024) {
      alert("Image must be smaller than 1MB");
      event.target.value = "";
      return;
    }

    // Replace initials div with image if needed
    if (preview.tagName !== "IMG") {
      const img = document.createElement("img");
      img.id = "profilePhotoPreview";
      img.className = "w-full h-full object-cover";
      preview.replaceWith(img);
    }

    document.getElementById("profilePhotoPreview").src =
      URL.createObjectURL(file);
  }
</script>

<script>
let currentRole = "student";

function openSearch() {
  document.getElementById("searchModal").classList.remove("hidden");
  document.getElementById("searchInput").value = "";
  document.getElementById("searchResults").innerHTML = "";
  document.getElementById("searchInput").focus();
}

function closeSearch() {
  document.getElementById("searchModal").classList.add("hidden");
}

function setSearchRole(role) {
  currentRole = role;

  document.getElementById("tabStudent").className =
    role === "student"
      ? "flex-1 py-2 rounded-xl bg-blue-600 text-white font-medium"
      : "flex-1 py-2 rounded-xl bg-gray-100 text-gray-600 font-medium";

  document.getElementById("tabTeacher").className =
    role === "teacher"
      ? "flex-1 py-2 rounded-xl bg-blue-600 text-white font-medium"
      : "flex-1 py-2 rounded-xl bg-gray-100 text-gray-600 font-medium";

  searchUsers();
}

function searchUsers() {
  const q = document.getElementById("searchInput").value.trim();
  const container = document.getElementById("searchResults");

  if (!q) {
    container.innerHTML = "";
    return;
  }

  fetch(`/accounts/search/?q=${encodeURIComponent(q)}&role=${currentRole}`)
    .then(res => res.json())
    .then(data => {
      container.innerHTML = "";

      if (data.results.length === 0) {
        container.innerHTML =
          `<p class="text-sm text-gray-400">No results found</p>`;
        return;
      }

      data.results.forEach(u => {
        container.insertAdjacentHTML("beforeend", `
          <div
            onclick="openUserProfile(${u.id})"
            class="border rounded-xl p-4 flex gap-4 hover:bg-gray-50 cursor-pointer"
          >
            <img src="${u.avatar}" class="w-10 h-10 rounded-full object-cover" />
            <div>
              <p class="font-semibold text-sm">${u.name}</p>
              <p class="text-xs text-gray-500">‚úâ ${u.email}</p>
              <p class="text-xs text-gray-500">üìç ${u.location}</p>
            </div>
          </div>
        `);
      });
    });
}
</script>


{% endblock %}
