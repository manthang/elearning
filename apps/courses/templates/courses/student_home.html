{% extends "core/base.html" %}
{% load humanize %}
{% block title %}Student Dashboard{% endblock %}

{% block content %}
<div class="bg-gray-50 min-h-screen p-6">

  <!-- ================= HEADER ================= -->
  <div class="flex justify-between items-center mb-8">
    <div>
      <h1 class="text-2xl font-bold">
        Welcome back,
        {{ request.user.full_name|default:request.user.username }}
      </h1>
      <p class="text-gray-500">Your learning dashboard</p>
    </div>

    <input
      type="text"
      placeholder="Search students / teachers"
      disabled
      class="px-4 py-2 border rounded-lg bg-gray-100
             text-gray-400 cursor-not-allowed"
    />
  </div>

  <div class="grid grid-cols-12 gap-6">

    <!-- ================= LEFT COLUMN ================= -->
    <div class="col-span-4 space-y-6">

      <!-- PROFILE CARD -->
      <div class="bg-white rounded-xl shadow p-6 space-y-4">
        <div class="flex justify-between items-start">
          <img
            src="{{ request.user.avatar_url }}"
            class="w-16 h-16 rounded-full object-cover"
            alt="Avatar"
          />

          <button
            type="button"
            id="openProfileModal"
            class="flex items-center gap-2
                   px-4 py-2 border rounded-full
                   text-sm font-medium text-gray-700
                   hover:bg-gray-50"
          >
            ‚úèÔ∏è <span>Edit</span>
          </button>
        </div>

        <div>
          <h2 class="text-lg font-semibold">
            {{ request.user.full_name|default:request.user.username }}
          </h2>
        </div>

        <ul class="text-sm text-gray-600 space-y-1">
          {% if request.user.location %}
            <li>üìç {{ request.user.location }}</li>
          {% endif %}
          <li>üìÖ Joined {{ request.user.date_joined|date:"F Y" }}</li>
          <li>üéì {{ enrolled_count }} Enrolled Courses</li>
        </ul>
      </div>

      <!-- UPCOMING DEADLINES -->
      <div class="bg-white rounded-xl shadow p-6">
        <h2 class="text-lg font-semibold mb-3">Upcoming Deadlines</h2>

        {% for d in deadlines %}
          <div class="mb-3">
            <p class="font-medium text-sm">{{ d.title }}</p>
            <p class="text-xs text-gray-500">{{ d.course.title }}</p>
            <p class="text-xs text-red-500">
              Due {{ d.due_at|naturaltime }}
            </p>
          </div>
        {% empty %}
          <p class="text-sm text-gray-400">
            No upcoming deadlines üéâ
          </p>
        {% endfor %}
      </div>
    </div>

    <!-- ================= RIGHT COLUMN ================= -->
    <div class="col-span-8">

      <!-- TABS -->
      <div class="mb-6 flex gap-6 border-b">
        <a href="?tab=courses"
           class="pb-2 {% if tab == 'courses' %}
                    border-b-2 border-blue-600 text-blue-600
                    {% else %} text-gray-500 {% endif %}">
          My Courses
        </a>

        <a href="?tab=all"
           class="pb-2 {% if tab == 'all' %}
                    border-b-2 border-blue-600 text-blue-600
                    {% else %} text-gray-500 {% endif %}">
          All Courses
        </a>

        <a href="?tab=status"
           class="pb-2 {% if tab == 'status' %}
                    border-b-2 border-blue-600 text-blue-600
                    {% else %} text-gray-500 {% endif %}">
          Status Updates
        </a>
      </div>

      <!-- ================= MY COURSES ================= -->
      {% if tab == "courses" %}
        <div class="grid grid-cols-2 gap-6">
          {% for course in courses %}
            <div class="bg-white rounded-xl shadow p-6 space-y-4">

              <h3 class="font-semibold text-lg">{{ course.title }}</h3>

              {% if course.teachers %}
                <p class="text-sm text-gray-500">
                  Prof.
                  {% for t in course.teachers %}
                    {{ t.full_name|default:t.username }}{% if not forloop.last %}, {% endif %}
                  {% endfor %}
                </p>
              {% else %}
                <p class="text-sm text-gray-400">Instructor TBA</p>
              {% endif %}

              <!-- Progress -->
              <div class="space-y-1">
                <div class="flex justify-between text-sm text-gray-600">
                  <span>Progress</span>
                  <span>{{ course.progress }}%</span>
                </div>
                <div class="h-2 bg-gray-200 rounded-full">
                  <div class="h-2 bg-blue-600 rounded-full"
                       style="width: {{ course.progress }}%"></div>
                </div>
              </div>

              <div class="flex gap-3 pt-2">
                <a
                  href="{% url 'courses:course_continue' course.id %}"
                  class="flex-1 flex items-center justify-center
                         px-4 py-2 border rounded-lg
                         hover:bg-gray-50">
                  ‚ñ∂ Continue
                </a>

                <button
                  type="button"
                  onclick="openFeedbackModal(
                    '{{ course.title|escapejs }}',
                    '{% url 'courses:course_feedback' course.id %}'
                  )"
                  class="w-10 h-10 border rounded-lg
                         flex items-center justify-center
                         hover:bg-gray-50"
                  title="Leave feedback">
                  üí¨
                </button>
              </div>
            </div>
          {% empty %}
            <p class="text-gray-400">No enrolled courses yet.</p>
          {% endfor %}
        </div>
      {% endif %}

      <!-- ================= ALL COURSES ================= -->
      {% if tab == "all" %}
        <div class="grid grid-cols-2 gap-6">
          {% for course in all_courses %}
            <div class="bg-white rounded-xl shadow p-6 space-y-4">

              <div class="flex justify-between items-start">
                <div>
                  <h3 class="font-semibold text-lg">{{ course.title }}</h3>

                  {% if course.teachers %}
                    <p class="text-sm text-gray-500">
                      Prof.
                      {% for t in course.teachers %}
                        {{ t.full_name|default:t.username }}{% if not forloop.last %}, {% endif %}
                      {% endfor %}
                    </p>
                  {% else %}
                    <p class="text-sm text-gray-400">Instructor TBA</p>
                  {% endif %}
                </div>

                {% if course.is_enrolled %}
                  <span class="px-3 py-1 text-sm rounded-lg
                               bg-green-100 text-green-700">
                    Active
                  </span>
                {% else %}
                  <span class="px-3 py-1 text-sm rounded-lg
                               bg-gray-100 text-gray-600">
                    Not Enrolled
                  </span>
                {% endif %}
              </div>

              <div class="flex gap-3 pt-2">
                {% if course.is_enrolled %}
                  <a
                    href="{% url 'courses:course_continue' course.id %}"
                    class="flex-1 flex items-center justify-center
                           px-4 py-2 border rounded-lg
                           hover:bg-gray-50">
                    ‚ñ∂ Continue
                  </a>
                {% else %}
                  <form method="post"
                        action="{% url 'courses:course_enroll' course.id %}"
                        class="flex-1">
                    {% csrf_token %}
                    <button
                      type="submit"
                      class="w-full px-4 py-2
                             bg-blue-600 text-white
                             rounded-lg hover:bg-blue-700">
                      ‚ûï Enroll
                    </button>
                  </form>
                {% endif %}

                {% if course.is_enrolled %}
                  <button
                    type="button"
                    onclick="openFeedbackModal(
                      '{{ course.title|escapejs }}',
                      '{% url 'courses:course_feedback' course.id %}'
                    )"
                    class="w-10 h-10 border rounded-lg
                          flex items-center justify-center
                          hover:bg-gray-50"
                    title="Leave feedback">
                    üí¨
                  </button>
                {% else %}
                  <button
                    type="button"
                    disabled
                    class="w-10 h-10 border rounded-lg
                          flex items-center justify-center
                          text-gray-300 cursor-not-allowed"
                    title="Enroll to leave feedback">
                    üí¨
                  </button>
                {% endif %}

              </div>
            </div>
          {% endfor %}
        </div>
      {% endif %}

      <!-- ================= STATUS UPDATES ================= -->
      {% if tab == "status" %}
        <form method="post" class="flex gap-4 mb-8">
          {% csrf_token %}
          <div class="w-12 h-12 rounded-full bg-gray-300"></div>
          <div class="flex-1">
            {{ form.content }}
            <div class="flex justify-end mt-3">
              <button class="bg-blue-600 text-white px-5 py-2 rounded-xl">
                Post Update
              </button>
            </div>
          </div>
        </form>

        <div class="space-y-6">
          {% for update in updates %}
            <div class="bg-white rounded-xl shadow p-4">
              <p class="font-semibold">
                {{ update.author.full_name|default:update.author.username }}
              </p>
              <p class="mt-2">{{ update.content }}</p>
              <p class="text-xs text-gray-400">
                {{ update.created_at|naturaltime }}
              </p>
            </div>
          {% endfor %}
        </div>
      {% endif %}
    </div>
  </div>
</div>

<!-- ================= FEEDBACK MODAL ================= -->
<div id="feedbackModal"
     class="fixed inset-0 bg-black/40 hidden
            flex items-center justify-center z-50">

  <div class="bg-white rounded-xl w-full max-w-lg p-6 relative">

    <div class="flex justify-between items-start mb-4">
      <div>
        <h2 class="text-xl font-semibold">Leave Feedback</h2>
        <p id="feedbackCourseTitle" class="text-gray-500 text-sm"></p>
      </div>

      <button onclick="closeFeedbackModal()"
              class="text-gray-400 hover:text-gray-600 text-xl">
        √ó
      </button>
    </div>

    <form method="post" id="feedbackForm">
      {% csrf_token %}
      <input type="hidden" name="rating" id="ratingInput">

      <p class="font-medium mb-2">How would you rate this course?</p>

      <div class="flex gap-2 text-3xl text-gray-300 cursor-pointer mb-4">
        {% for i in "12345" %}
          <span onclick="setRating({{ forloop.counter }})"
                id="star{{ forloop.counter }}">‚òÖ</span>
        {% endfor %}
      </div>

      <label class="font-medium block mb-1">
        Additional Comments (Optional)
      </label>
      <textarea name="comment"
                class="w-full border rounded-lg p-3 mb-6"
                rows="4"
                placeholder="Share your thoughts about the course, instructor, or learning experience...">
      </textarea>

      <div class="flex justify-end gap-3">
        <button type="button"
                onclick="closeFeedbackModal()"
                class="px-4 py-2 border rounded-lg">
          Cancel
        </button>
        <button type="submit"
                class="px-6 py-2 bg-blue-600 text-white rounded-lg">
          Submit Feedback
        </button>
      </div>
    </form>
  </div>
</div>

<script>
  function openFeedbackModal(courseTitle, actionUrl) {
    document.getElementById("feedbackModal").classList.remove("hidden");
    document.getElementById("feedbackCourseTitle").innerText = courseTitle;
    document.getElementById("feedbackForm").action = actionUrl;
    setRating(0);
  }

  function closeFeedbackModal() {
    document.getElementById("feedbackModal").classList.add("hidden");
  }

  function setRating(value) {
    document.getElementById("ratingInput").value = value;
    for (let i = 1; i <= 5; i++) {
      document.getElementById("star" + i).style.color =
        i <= value ? "#2563eb" : "#d1d5db";
    }
  }
</script>

{% endblock %}
