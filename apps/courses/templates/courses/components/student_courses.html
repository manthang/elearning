<div>
  <style>
    /* Rating label swap (Udemy-like) */
    .rating-chip:hover .rating-default { display: none; }
    .rating-chip:hover .rating-hover { display: inline; }

    /* Feedback modal (match Add Deadlines modal vibe) */
    .modal-backdrop[aria-hidden="true"] { display: none; }
    .modal-backdrop { position: fixed; inset: 0; z-index: 60; background: rgba(15, 23, 42, .45); }
    .modal-panel { max-width: 520px; width: calc(100% - 2rem); }

    /* Stars */
    .star-btn { transition: transform .12s ease, filter .12s ease; }
    .star-btn:hover { transform: translateY(-1px) scale(1.05); }
    .star-btn:active { transform: translateY(0) scale(.98); }

    /* (Optional) prevent body scroll when modal open */
    body.modal-open { overflow: hidden; }
  </style>

  <div class="flex items-center justify-between mb-6">
    <div>
      <p class="text-sm text-gray-500 mt-1">Stay on track with your enrolled courses.</p>
    </div>

    <div class="relative w-full sm:w-72 group">
      <input type="text"
             placeholder="Search your courses..."
             class="w-full pl-10 pr-4 py-2.5 rounded-xl border border-gray-200
                    bg-white shadow-sm transition-all
                    text-sm text-gray-700
                    focus:outline-none focus:ring-4 focus:ring-blue-500/10
                    focus:border-blue-500 group-hover:border-gray-300" />
      <svg xmlns="http://www.w3.org/2000/svg"
           class="absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-gray-400 group-focus-within:text-blue-500 transition-colors"
           viewBox="0 0 24 24" fill="none"
           stroke="currentColor" stroke-width="2">
        <circle cx="11" cy="11" r="8"/>
        <line x1="21" y1="21" x2="16.65" y2="16.65"/>
      </svg>
    </div>
  </div>

  <div class="mt-6 space-y-4" id="myCoursesList">
    {% for c in enrolled_courses %}
      {% with pct=c.progress|default:0 %}
      <div class="group relative overflow-hidden bg-white rounded-2xl border border-gray-200 shadow-sm hover:shadow-md hover:border-gray-300 transition"
           data-course-title="{{ c.title|lower }}"
           data-course-display-title="{{ c.title|escapejs }}"
           data-course-instructor="{% for t in c.teachers %}{{ t.full_name|default:t.username }}{% if not forloop.last %}, {% endif %}{% endfor %}"
           data-course-id="{{ c.id }}"
           data-detail-url="{% url 'courses:course_detail' c.id %}"
           data-feedback-rating="{{ c.feedback_rating|default:0 }}"
           data-feedback-comment="{{ c.feedback_comment|default:''|escapejs }}">

        <!-- Stretched link (card click) -->
        <a href="{% url 'courses:course_detail' c.id %}" class="absolute inset-0 z-0" aria-label="Open course"></a>

        <div class="relative z-10 flex items-stretch">
          <!-- Left media -->
          <div class="relative w-56 shrink-0 bg-gray-100">
            {% if c.thumbnail %}
              <img src="{{ c.thumbnail.url }}" alt="{{ c.title }}" class="h-full w-full object-cover"/>
            {% else %}
              <div class="h-full w-full bg-gradient-to-br from-slate-100 to-slate-200"></div>
            {% endif %}

            <!-- Hover Start/Resume action (center) -->
            <a href="{% url 'courses:course_detail' c.id %}"
               class="absolute inset-0 flex items-center justify-center z-20"
               onclick="event.stopPropagation();">
              <span class="opacity-0 scale-95 group-hover:opacity-100 group-hover:scale-100 transition
                          inline-flex items-center justify-center h-14 w-14 rounded-full shadow-lg
                          {% if pct|default:0 > 0 %}bg-blue-600 hover:bg-blue-700{% else %}bg-emerald-600 hover:bg-emerald-700{% endif %}
                          text-white ring-4 ring-white/60
                          active:scale-95">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M8 5v14l11-7z"/>
                </svg>
              </span>
            </a>
          </div>

          <!-- Right content -->
          <div class="flex-1 min-w-0 px-6 py-5">
            <h4 class="text-xl font-semibold text-gray-900 leading-snug line-clamp-2">
              {{ c.title }}
            </h4>

            <div class="mt-2 text-sm text-gray-600 truncate">
              {% for t in c.teachers %}
                {{ t.full_name|default:t.username }}{% if not forloop.last %}, {% endif %}
              {% empty %}
                <span class="text-gray-400">Instructor TBA</span>
              {% endfor %}
            </div>

            <!-- Meta -->
            <div class="mt-3 flex items-center gap-4 text-sm text-gray-500">
              <span>{{ c.duration|default:"—" }} weeks</span>
              <span class="text-gray-300">•</span>
              <span>{{ c.enrollment_count|default:0 }} students</span>
            </div>

            <!-- Progress bar -->
            <div class="mt-6">
              <div class="flex items-center justify-between">
                <div class="text-sm text-gray-700">
                  <span class="font-medium">{{ pct }}%</span> <span class="text-gray-600">complete</span>
                </div>
              </div>

              <div class="mt-2 h-1.5 w-full rounded-full bg-gray-100 overflow-hidden">
                <div class="h-full rounded-full bg-purple-600 transition-all" style="width: {{ pct }}%;"></div>
              </div>

              <!-- Rating (below progress bar) -->
              <div class="mt-3 flex items-center justify-end">
                <button type="button"
                        class="rating-chip inline-flex items-center gap-2 text-sm text-gray-700 hover:text-gray-900 z-20"
                        data-open-feedback="1"
                        onclick="event.stopPropagation();">
                  <span class="inline-flex items-center gap-0.5" data-rating-stars>
                    {% for i in "12345" %}
                      <svg xmlns="http://www.w3.org/2000/svg"
                           class="h-4 w-4 {% if c.feedback_rating|default:0 >= forloop.counter %}text-amber-500{% else %}text-gray-300{% endif %}"
                           viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/>
                      </svg>
                    {% endfor %}
                  </span>

                  {% if c.feedback_rating|default:0 > 0 %}
                    <span class="rating-default text-gray-600" data-rating-label>Your rating</span>
                    <span class="rating-hover hidden text-gray-900 font-medium">Edit rating</span>
                  {% else %}
                    <span class="rating-default text-gray-600" data-rating-label>Leave a rating</span>
                    <span class="rating-hover hidden text-gray-900 font-medium">Leave a rating</span>
                  {% endif %}
                </button>
              </div>
            </div>

          </div>
        </div>
      </div>
      {% endwith %}
    {% empty %}
      <div class="rounded-2xl border border-gray-200 bg-gray-50 p-6 text-sm text-gray-500">
        You haven’t enrolled in any courses yet.
      </div>
    {% endfor %}
  </div>

  <!-- Feedback Modal -->
  <div id="feedbackModal" class="modal-backdrop" aria-hidden="true" role="dialog" aria-modal="true">
    <div class="h-full w-full flex items-center justify-center p-4">
      <div class="modal-panel bg-white rounded-2xl shadow-xl border border-gray-200">
        <div class="px-6 py-5 border-b border-gray-100">
          <div class="flex items-start justify-between gap-4">
            <div class="min-w-0">
              <h3 class="text-lg font-semibold text-gray-900">Leave a feedback</h3>
              <p id="feedbackCourseTitle" class="mt-1 text-sm text-gray-500 truncate">—</p>
            </div>
            <button type="button" id="closeFeedbackModalBtn"
                    class="shrink-0 inline-flex items-center justify-center h-9 w-9 rounded-xl border border-gray-200
                           text-gray-600 hover:bg-gray-50 hover:text-gray-800 transition"
                    aria-label="Close">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M18 6L6 18"/><path d="M6 6l12 12"/>
              </svg>
            </button>
          </div>
        </div>

        <form id="feedbackForm" class="px-6 py-5" method="post" action="">
          {% csrf_token %}
          <input type="hidden" id="feedbackCourseId" name="course_id" value="">
          <input type="hidden" id="feedbackRating" name="rating" value="">
          <input type="hidden" id="feedbackNext" name="next" value="{{ request.path }}?tab=courses">

          <div>
            <label class="block text-sm font-medium text-gray-700">Your rating</label>
            <div class="mt-3 flex items-center gap-1" id="feedbackStars">
              {% for i in "12345" %}
              <button type="button" class="star-btn" data-star="{{ forloop.counter }}" aria-label="Rate {{ forloop.counter }}">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-gray-300" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/>
                </svg>
              </button>
              {% endfor %}
              <span class="ml-3 text-sm text-gray-500" id="feedbackHint">Select a rating</span>
            </div>
          </div>

          <div class="mt-5">
            <label class="block text-sm font-medium text-gray-700">
              Comment <span class="text-gray-400">(optional)</span>
            </label>
            <textarea id="feedbackComment" name="comment" rows="3"
                      class="mt-2 w-full rounded-xl border border-gray-200 px-4 py-3 text-sm text-gray-700
                             focus:outline-none focus:ring-4 focus:ring-blue-500/10 focus:border-blue-500"
                      placeholder="Share what you liked or what could be improved..."></textarea>
          </div>

          <div class="mt-6 flex items-center justify-end gap-3">
            <button type="button" id="cancelFeedbackBtn"
                    class="px-4 py-2 rounded-xl border border-gray-200 bg-white text-sm font-semibold text-gray-700
                           hover:bg-gray-50 hover:border-gray-300 transition">
              Cancel
            </button>

            <button type="submit" id="saveFeedbackBtn" disabled
                    class="px-4 py-2 rounded-xl text-sm font-semibold text-white transition
                           bg-blue-600/60 cursor-not-allowed
                           enabled:bg-blue-600 enabled:hover:bg-blue-700 enabled:cursor-pointer
                           focus:outline-none focus:ring-4 focus:ring-blue-500/20">
              Save
            </button>
          </div>
        </form>

      </div>
    </div>
  </div>

  <script>
    (function () {
      const modal = document.getElementById('feedbackModal');
      const modalPanel = modal ? modal.querySelector('.modal-panel') : null;

      const form = document.getElementById('feedbackForm');
      const courseTitleEl = document.getElementById('feedbackCourseTitle');

      const courseIdInput = document.getElementById('feedbackCourseId');
      const ratingInput = document.getElementById('feedbackRating');
      const commentInput = document.getElementById('feedbackComment');

      const starsWrap = document.getElementById('feedbackStars');
      const hintEl = document.getElementById('feedbackHint');

      const saveBtn = document.getElementById('saveFeedbackBtn');
      const cancelBtn = document.getElementById('cancelFeedbackBtn');
      const closeBtn = document.getElementById('closeFeedbackModalBtn');

      if (!modal || !form || !starsWrap || !saveBtn) return;

      let initialRating = 0;
      let initialComment = '';
      let currentRating = 0;

      function openModal() {
        modal.setAttribute('aria-hidden', 'false');
        document.body.classList.add('modal-open');

        // focus comment for quick typing
        setTimeout(() => {
          commentInput && commentInput.focus();
        }, 0);
      }

      function closeModal({ reset = true } = {}) {
        modal.setAttribute('aria-hidden', 'true');
        document.body.classList.remove('modal-open');

        if (reset) {
          // Reset fields so next open is cleanly re-filled
          courseTitleEl.textContent = '—';
          courseIdInput.value = '';
          ratingInput.value = '';
          commentInput.value = '';
          form.action = '';
          initialRating = 0;
          initialComment = '';
          currentRating = 0;
          renderStars(0);
          setHint(0);
          setSaveEnabled(false);
        }
      }

      function setSaveEnabled(enabled) {
        saveBtn.disabled = !enabled;
      }

      function setHint(rating) {
        if (!hintEl) return;
        if (!rating) hintEl.textContent = 'Select a rating';
        else if (rating <= 2) hintEl.textContent = 'Needs improvement';
        else if (rating === 3) hintEl.textContent = 'Okay';
        else if (rating === 4) hintEl.textContent = 'Good';
        else hintEl.textContent = 'Excellent';
      }

      function renderStars(rating) {
        const starButtons = starsWrap.querySelectorAll('[data-star]');
        starButtons.forEach((btn) => {
          const n = parseInt(btn.getAttribute('data-star'), 10);
          const svg = btn.querySelector('svg');
          if (!svg) return;

          if (n <= rating) {
            svg.classList.remove('text-gray-300');
            svg.classList.add('text-amber-500');
          } else {
            svg.classList.remove('text-amber-500');
            svg.classList.add('text-gray-300');
          }
        });
      }

      function hasChanges() {
        const comment = (commentInput.value || '').trim();
        const rating = parseInt(ratingInput.value || '0', 10) || 0;

        const ratingChanged = rating !== (initialRating || 0);
        const commentChanged = comment !== (initialComment || '');

        // Require a rating to enable save (common UX + backend-friendly)
        const ratingValid = rating >= 1;

        return ratingValid && (ratingChanged || commentChanged);
      }

      function syncSaveState() {
        setSaveEnabled(hasChanges());
      }

      function fillFromCard(card) {
        const courseId = card.getAttribute('data-course-id');
        const displayTitle = card.getAttribute('data-course-display-title') || '';
        const rating = parseInt(card.getAttribute('data-feedback-rating') || '0', 10) || 0;
        const comment = card.getAttribute('data-feedback-comment') || '';

        // store initials for dirty-checking
        initialRating = rating;
        initialComment = (comment || '').trim();

        currentRating = rating;

        // fill UI
        courseTitleEl.textContent = displayTitle || '—';
        courseIdInput.value = courseId || '';
        ratingInput.value = String(rating || 0);
        commentInput.value = comment || '';

        renderStars(rating || 0);
        setHint(rating || 0);

        // set action to /courses/<id>/feedback/
        if (courseId) {
          form.action = `/courses/${courseId}/feedback/`;
        } else {
          form.action = '';
        }

        // Save disabled until user changes something
        syncSaveState();
      }

      // 1) Click rating area -> open modal, fill existing values
      document.querySelectorAll('[data-open-feedback]').forEach((btn) => {
        btn.addEventListener('click', (e) => {
          e.preventDefault();
          e.stopPropagation();

          const card = btn.closest('[data-course-id]');
          if (!card) return;

          fillFromCard(card);
          openModal();
        });
      });

      // Stars click updates rating + enables save only if changed
      starsWrap.addEventListener('click', (e) => {
        const btn = e.target.closest('[data-star]');
        if (!btn) return;

        const rating = parseInt(btn.getAttribute('data-star'), 10) || 0;
        currentRating = rating;
        ratingInput.value = String(rating);

        renderStars(rating);
        setHint(rating);
        syncSaveState();
      });

      // Comment typing affects save enabled state
      if (commentInput) {
        commentInput.addEventListener('input', () => {
          syncSaveState();
        });
      }

      // 2) Only enable Save if there are changes
      // handled by syncSaveState()

      // 3) Save submits to /courses/<id>/feedback/ (non-AJAX)
      // (Optional) store a flag; not required because the redirect reload shows latest rating.
      form.addEventListener('submit', () => {
        // If you ever want to detect after reload, you can use this:
        sessionStorage.setItem('feedback_submitted', '1');
      });

      // Close behaviors
      cancelBtn && cancelBtn.addEventListener('click', () => closeModal());
      closeBtn && closeBtn.addEventListener('click', () => closeModal());

      // Click backdrop closes (but clicking panel doesn’t)
      modal.addEventListener('click', (e) => {
        if (modalPanel && modalPanel.contains(e.target)) return;
        closeModal();
      });

      // ESC closes
      document.addEventListener('keydown', (e) => {
        if (e.key !== 'Escape') return;
        if (modal.getAttribute('aria-hidden') === 'false') closeModal();
      });

      // 4) After closing modal, refresh my courses to show latest rating:
      // In non-AJAX flow, after Save the server redirects back to this page,
      // so you already see latest rating immediately.
      // (We do NOT force reload on close/cancel to avoid unnecessary refresh.)
    })();
  </script>
</div>