<div class="bg-white rounded-2xl border border-gray-200 shadow-sm p-6">
  <div class="flex items-center justify-between gap-4">
    <div>
      <h2 class="text-xl font-bold text-gray-900">Materials</h2>
      <p class="mt-1 text-sm text-gray-500">Files for students to download and review.</p>
    </div>

    {% if is_teacher_view %}
    <form id="uploadMaterialForm"
          method="post"
          action="{% url 'courses:material_upload' course.id %}"
          enctype="multipart/form-data"
          class="shrink-0">
      {% csrf_token %}

      <!-- hidden OS file picker -->
      <input id="materialFileInput"
            type="file"
            name="file"
            class="hidden"
            onchange="handleMaterialFileChosen()" />

      <button type="button"
              onclick="openMaterialPicker()"
              class="inline-flex items-center gap-2 px-4 py-2 rounded-xl bg-blue-600 text-white font-semibold hover:bg-blue-700 transition shadow-sm">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
          <path d="M3 16a2 2 0 002 2h10a2 2 0 002-2v-5h-2v5H5v-5H3v5z"/>
          <path d="M7 8l3-3 3 3H11v6H9V8H7z"/>
        </svg>
        Upload Material
      </button>
    </form>
    {% endif %}
  </div>

  <div class="mt-5 space-y-4">
    {% for m in materials %}
      <div class="rounded-2xl border border-gray-200 bg-white p-5">
        <div class="flex items-center justify-between gap-4">

          <!-- Left -->
          <div class="flex items-center gap-4 min-w-0">
            <div class="w-14 h-14 rounded-2xl bg-gray-50 border border-gray-100 flex items-center justify-center shrink-0">
              <!-- file icon -->
              <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7 text-gray-500" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                <path d="M14 2v6h6"/>
              </svg>
            </div>

            <div class="min-w-0">
              <div class="font-semibold text-gray-900 truncate">
                {% if m.original_name %}
                  {{ m.original_name }}
                {% else %}
                  {{ m.file.name|default:"Material" }}
                {% endif %}
              </div>

              <div class="mt-1 flex flex-wrap items-center gap-3 text-sm text-gray-500">
                <span class="inline-flex items-center px-2 py-0.5 rounded-full bg-blue-50 text-blue-700 border border-blue-100 text-xs font-semibold">
                  FILE
                </span>
                <span>Uploaded {{ m.uploaded_at|date:"M d, Y" }}</span>
              </div>
            </div>
          </div>

          <!-- Right -->
          <div class="flex items-center gap-2 shrink-0">
            {% if m.file %}
              <a href="{{ m.file.url }}"
                  class="w-11 h-11 rounded-xl border border-gray-200 bg-gray-50
                        flex items-center justify-center text-gray-600
                        hover:bg-gray-100 transition"
                  aria-label="Download">
                <!-- download icon -->
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                  <polyline points="7 10 12 15 17 10"/>
                  <line x1="12" y1="15" x2="12" y2="3"/>
                </svg>
              </a>
            {% endif %}

            {% if is_teacher_view %}
                <button type="button"
                        class="w-11 h-11 rounded-xl border border-red-200 bg-red-50
                            flex items-center justify-center text-red-600
                            hover:bg-red-100 transition"
                        aria-label="Delete material"
                        onclick="openDeleteMaterialModal('{{ m.id }}', '{{ m.original_name|default:m.file.name|escapejs }}')">
                    <!-- trash icon -->
                    <svg xmlns="http://www.w3.org/2000/svg"
                            class="h-5 w-5"
                            viewBox="0 0 24 24"
                            fill="none"
                            stroke="currentColor"
                            stroke-width="2"
                            stroke-linecap="round"
                            stroke-linejoin="round">
                        <polyline points="3 6 5 6 21 6"/>
                        <path d="M19 6l-2 14H7L5 6"/>
                        <path d="M10 11v6"/>
                        <path d="M14 11v6"/>
                        <path d="M9 6V4h6v2"/>
                    </svg>
                </button>
            {% endif %}
          </div>
        </div>
      </div>
    {% empty %}
      <div class="rounded-2xl border border-gray-200 bg-gray-50 p-6 text-sm text-gray-500">
        No materials uploaded yet.
      </div>
    {% endfor %}
  </div>
</div>

<div id="deleteMaterialModal"
     class="fixed inset-0 z-50 hidden items-center justify-center bg-black/40 backdrop-blur-sm"
     onclick="closeDeleteMaterialModal()">

  <div class="w-full max-w-md rounded-2xl bg-white shadow-[0_30px_90px_rgba(0,0,0,0.25)] overflow-hidden"
       onclick="event.stopPropagation()">

    <!-- Header -->
    <div class="px-6 py-5 border-b border-gray-100 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 rounded-xl bg-red-50 text-red-600 flex items-center justify-center">
          ⚠
        </div>

        <div>
          <div class="text-base font-semibold text-gray-900">Delete material</div>
          <div class="text-sm text-gray-500">This action cannot be undone.</div>
        </div>
      </div>

      <button type="button"
              class="w-10 h-10 rounded-full hover:bg-gray-100 flex items-center justify-center transition"
              onclick="closeDeleteMaterialModal()">
        ✕
      </button>
    </div>

    <!-- Body -->
    <div class="px-6 py-5">
      <p class="text-sm text-gray-700">
        Are you sure you want to delete
        <span id="deleteMaterialName" class="font-semibold text-gray-900">this file</span>?
      </p>
    </div>

    <!-- Footer -->
    <div class="px-6 py-5 border-t border-gray-100 flex items-center justify-end gap-3">
      <button type="button"
              class="px-5 py-2.5 rounded-xl border border-gray-200 text-gray-700 font-semibold hover:bg-gray-50 transition"
              onclick="closeDeleteMaterialModal()">
        Cancel
      </button>

      <form id="deleteMaterialForm" method="post" action="">
        {% csrf_token %}
        <button type="submit"
                class="px-5 py-2.5 rounded-xl bg-red-600 text-white font-semibold hover:bg-red-700 transition">
          Delete
        </button>
      </form>
    </div>

  </div>
</div>

<script>
  function openMaterialPicker() {
    const input = document.getElementById("materialFileInput");
    if (!input) return;

    input.value = "";
    input.click();
  }

  function handleMaterialFileChosen() {
    const input = document.getElementById("materialFileInput");
    const form = document.getElementById("uploadMaterialForm");
    if (!input || !form) return;

    if (input.files && input.files.length > 0) {
      form.submit();
    }
  }

  function openDeleteMaterialModal(materialId, materialName) {
    const modal = document.getElementById("deleteMaterialModal");
    const nameEl = document.getElementById("deleteMaterialName");
    const formEl = document.getElementById("deleteMaterialForm");

    if (!modal || !nameEl || !formEl) return;

    nameEl.textContent = materialName || "this file";

    const courseId = "{{ course.id }}";
    formEl.action = `/courses/${courseId}/materials/${materialId}/delete/`;

    modal.classList.remove("hidden");
    modal.classList.add("flex");

    document.addEventListener("keydown", escCloseDeleteModal);
  }

  function closeDeleteMaterialModal() {
    const modal = document.getElementById("deleteMaterialModal");

    modal.classList.add("hidden");
    modal.classList.remove("flex");

    document.removeEventListener("keydown", escCloseDeleteModal);
  }

  function escCloseDeleteModal(e) {
    if (e.key === "Escape") closeDeleteMaterialModal();
  }
</script>
