<div id="profileModal"
     class="fixed inset-0 z-50 hidden items-center justify-center bg-black/40 backdrop-blur-sm"
     onclick="closeProfileModal()">

  <div class="w-[92%] max-w-2xl" onclick="event.stopPropagation()">
    <div class="bg-white rounded-3xl shadow-[0_30px_90px_rgba(0,0,0,0.25)] overflow-hidden border border-gray-200 max-h-[90vh] flex flex-col">

      <!-- Header -->
      <div class="px-6 py-5 border-b border-gray-100 flex items-start justify-between gap-4">
        <div class="min-w-0">
          <div class="text-2xl font-extrabold text-gray-900 leading-tight">Personal Details</div>
          <div class="mt-1 text-sm text-gray-500">
            Update your profile information as it appears in our website.
          </div>
        </div>

        <button type="button"
                onclick="closeProfileModal()"
                class="w-10 h-10 rounded-xl hover:bg-gray-100 flex items-center justify-center text-gray-500"
                aria-label="Close">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="none"
               stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M18 6 6 18"/><path d="m6 6 12 12"/>
          </svg>
        </button>
      </div>

      <!-- Body -->
      <form id="profileEditForm" 
            method="post" 
            action="{% url 'accounts:edit_profile' %}"
            enctype="multipart/form-data"
            class="px-6 py-5 space-y-5 overflow-y-auto">
        {% csrf_token %}

        <input type="hidden" name="next" value="{{ request.path }}">

        <!-- Photo -->
        <div>
          <label class="block text-sm font-semibold text-gray-800 mb-2">Profile Photo</label>

          <div class="flex items-start gap-4">
            <!-- Preview  -->
            <div class="w-20 h-20 rounded-xl overflow-hidden bg-gray-100 border border-gray-200 shrink-0">
              {% if request.user.profile_photo %}
                <img id="profilePhotoPreview"
                     src="{{ request.user.avatar_url }}"
                     alt="Profile photo"
                     class="w-full h-full object-cover" />
              {% else %}
                <div id="profilePhotoPreview"
                     class="w-full h-full flex items-center justify-center text-gray-600 font-bold text-xl">
                  {{ request.user.full_name|default:request.user.username|first }}
                </div>
              {% endif %}
            </div>

            <div class="flex-1">
              <div class="flex flex-wrap items-center gap-3">
                <label for="profilePhotoInput"
                       class="inline-flex items-center gap-2 px-4 py-2 rounded-xl bg-blue-600 text-white font-semibold
                              hover:bg-blue-700 transition shadow-sm cursor-pointer">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 24 24" fill="none"
                       stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                    <polyline points="17 8 12 3 7 8"/>
                    <line x1="12" y1="3" x2="12" y2="15"/>
                  </svg>
                  Upload photo
                </label>

                <button type="button"
                        onclick="clearProfilePhoto()"
                        class="inline-flex items-center gap-2 px-4 py-2 rounded-xl border border-gray-200 bg-white
                               text-sm font-semibold text-gray-700 hover:bg-gray-50 hover:border-gray-300 transition">
                  Remove
                </button>

                <input id="profilePhotoInput"
                       type="file"
                       name="profile_photo"
                       accept="image/*"
                       onchange="previewProfilePhoto(event)"
                       class="hidden" />

                <input type="hidden" name="remove_photo" id="removePhotoFlag" value="0">
              </div>

              <p class="mt-2 text-xs text-gray-500">
                PNG/JPG recommended. Keep it under 1MB.
              </p>
            </div>
          </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <!-- Full name -->
          <div>
            <label class="block text-sm font-semibold text-gray-800 mb-2">
              Full name <span class="text-red-500">*</span>
            </label>
            <input type="text"
                   name="full_name"
                   required
                   value="{{ request.user.full_name }}"
                   class="w-full rounded-2xl border border-gray-200 px-4 py-3 text-sm
                          focus:outline-none focus:ring-2 focus:ring-blue-200"
                   placeholder="Your name" />
          </div>

          <!-- Email -->
          <div>
            <label class="block text-sm font-semibold text-gray-800 mb-2">Email</label>
            <input type="email"
                   name="email"
                   value="{{ request.user.email }}"
                   readonly
                   class="w-full rounded-2xl border border-gray-200 px-4 py-3 text-sm bg-gray-50 text-gray-700
                          focus:outline-none"
                   placeholder="you@example.com" />
            <p class="mt-1 text-xs text-gray-500">Email is read-only.</p>
          </div>
        </div>

        <!-- Location -->
        <div>
          <label class="block text-sm font-semibold text-gray-800 mb-2">Location</label>
          <input type="text"
                 name="location"
                 value="{{ request.user.location|default_if_none:'' }}"
                 placeholder="e.g., Ho Chi Minh City, Vietnam"
                 class="w-full rounded-2xl border border-gray-200 px-4 py-3 text-sm
                        focus:outline-none focus:ring-2 focus:ring-blue-200" />
        </div>

        <!-- Bio -->
        <div>
          <label class="block text-sm font-semibold text-gray-800 mb-2">Bio</label>
          <textarea name="bio"
                    rows="3"
                    class="w-full rounded-2xl border border-gray-200 px-4 py-3 text-sm
                           focus:outline-none focus:ring-2 focus:ring-blue-200"
                    placeholder="Tell others a little about yourself...">{{ request.user.bio }}</textarea>
        </div>
      </form>

      <!-- Footer -->
      <div class="px-6 py-5 border-t border-gray-100 bg-white">
        <div class="grid grid-cols-2 gap-4">
          <button type="button"
                  onclick="closeProfileModal()"
                  class="w-full px-4 py-3 rounded-2xl border border-gray-200 font-semibold text-gray-700 hover:bg-gray-50">
            Cancel
          </button>

          <button type="submit" form="profileEditForm"
                  class="w-full px-4 py-3 rounded-2xl bg-blue-600 text-white font-semibold hover:bg-blue-700
                         shadow-[0_12px_30px_rgba(37,99,235,0.25)]">
            Save changes
          </button>
        </div>
      </div>

    </div>
  </div>
</div>

<script>
  function openProfileModal() {
    const m = document.getElementById("profileModal");
    if (!m) return;
    m.classList.remove("hidden");
    m.classList.add("flex");
    document.addEventListener("keydown", escCloseProfileModal);
  }

  function closeProfileModal() {
    const m = document.getElementById("profileModal");
    if (!m) return;
    m.classList.add("hidden");
    m.classList.remove("flex");
    document.removeEventListener("keydown", escCloseProfileModal);
  }

  function escCloseProfileModal(e) {
    if (e.key === "Escape") closeProfileModal();
  }

  function previewProfilePhoto(event) {
    const input = event.target;
    const preview = document.getElementById("profilePhotoPreview");
    const removeFlag = document.getElementById("removePhotoFlag");
    if (!preview || !input.files || !input.files[0]) return;

    // If user selects a file, it means "not removing"
    if (removeFlag) removeFlag.value = "0";

    const file = input.files[0];
    const url = URL.createObjectURL(file);

    // If preview is a div (initial letter), replace with an img
    if (preview.tagName.toLowerCase() !== "img") {
      const img = document.createElement("img");
      img.id = "profilePhotoPreview";
      img.alt = "Profile photo";
      img.className = "w-full h-full object-cover";
      img.src = url;
      preview.replaceWith(img);
      return;
    }

    preview.src = url;
  }

  function clearProfilePhoto() {
    const input = document.getElementById("profilePhotoInput");
    const removeFlag = document.getElementById("removePhotoFlag");
    if (input) input.value = "";
    if (removeFlag) removeFlag.value = "1";

    // Visually reset preview to initial letter
    const existing = document.getElementById("profilePhotoPreview");
    if (existing) {
      const letter = "{{ request.user.full_name|default:request.user.username|first }}";
      const div = document.createElement("div");
      div.id = "profilePhotoPreview";
      div.className = "w-full h-full flex items-center justify-center text-gray-600 font-bold text-xl";
      div.textContent = letter;
      existing.replaceWith(div);
    }
  }
</script>
