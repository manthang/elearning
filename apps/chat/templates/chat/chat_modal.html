{% load static %}

<div id="messengerPanel"
     class="fixed inset-0 z-50 hidden items-center justify-center
            bg-black/40 backdrop-blur-sm opacity-0 transition-opacity duration-200">

  <button onclick="closeMessenger()"
          class="absolute top-6 right-6 md:top-8 md:right-8 z-50 p-2.5 
                 text-white/70 hover:text-white bg-black/20 hover:bg-black/60 
                 rounded-full backdrop-blur-md shadow-lg transition-all"
          aria-label="Close Messenger">
    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5">
      <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
    </svg>
  </button>

  <div id="messengerBox"
       class="w-full max-w-6xl h-[84vh] relative
              rounded-2xl overflow-hidden
              shadow-[0_24px_80px_rgba(0,0,0,0.25)]
              flex transform scale-95 opacity-0 transition-all duration-200 bg-white">

    <!-- ================= LEFT (Sidebar) ================= -->
    <aside class="w-[380px] flex flex-col bg-white border-r border-gray-100">

      <!-- Sidebar header -->
      <div class="px-4 py-3 flex items-center justify-between bg-white">
        <div class="flex items-center gap-3">
          <div class="h-9 w-9 rounded-full bg-gray-100 flex items-center justify-center">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-500" viewBox="0 0 20 20" fill="currentColor">
              <path d="M10 10a4 4 0 100-8 4 4 0 000 8zM3 18a7 7 0 0114 0H3z"/>
            </svg>
          </div>
          <div class="font-semibold text-gray-900">Chats</div>
        </div>

        <button type="button"
                class="h-9 w-9 rounded-full hover:bg-gray-100 transition flex items-center justify-center"
                aria-label="New chat">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-500" viewBox="0 0 20 20" fill="currentColor">
            <path d="M17 3a1 1 0 011 1v11a2 2 0 01-2 2H7l-4 3v-3H4a2 2 0 01-2-2V4a1 1 0 011-1h14z"/>
          </svg>
        </button>
      </div>

      <!-- Search (NO border-top line under Chats) -->
      <div class="px-3 pb-2 bg-white">
        <div class="flex items-center gap-2 bg-gray-100 rounded-lg px-3 py-2">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-500" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M12.9 14.32a8 8 0 111.414-1.414l3.387 3.387a1 1 0 01-1.414 1.414l-3.387-3.387zM14 8a6 6 0 11-12 0 6 6 0 0112 0z" clip-rule="evenodd"/>
          </svg>
          <input id="chatSearch"
                 type="text"
                 placeholder="Search"
                 class="w-full bg-transparent outline-none text-sm text-gray-700 placeholder:text-gray-400"
                 autocomplete="off"/>
        </div>
      </div>

      <!-- Conversations -->
      <div id="conversationList"
           class="flex-1 overflow-y-auto">
        <!-- injected by JS -->
      </div>

    </aside>

    <!-- ================= RIGHT (Chat) ================= -->
    <main class="flex-1 flex flex-col bg-white">

      <!-- Header -->
      <div id="chatHeader"
           class="hidden px-4 py-3 flex items-center gap-3 bg-white border-b border-gray-100">
        <img id="chatAvatar"
             class="w-10 h-10 rounded-full object-cover"
             alt="Avatar" />

        <div class="min-w-0">
          <div id="chatName" class="font-semibold text-sm text-gray-900 truncate"></div>
          <div id="chatRole" class="text-[11px] text-gray-500 uppercase tracking-wide truncate"></div>
        </div>

        <div class="ml-auto flex items-center gap-1">
          <button type="button"
                  class="h-9 w-9 rounded-full hover:bg-gray-100 transition flex items-center justify-center"
                  aria-label="Search">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-500" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd" d="M12.9 14.32a8 8 0 111.414-1.414l3.387 3.387a1 1 0 01-1.414 1.414l-3.387-3.387zM14 8a6 6 0 11-12 0 6 6 0 0112 0z" clip-rule="evenodd"/>
            </svg>
          </button>
          <button type="button"
                  class="h-9 w-9 rounded-full hover:bg-gray-100 transition flex items-center justify-center"
                  aria-label="Menu">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-500" viewBox="0 0 20 20" fill="currentColor">
              <path d="M6 10a2 2 0 114 0 2 2 0 01-4 0zm6 0a2 2 0 114 0 2 2 0 01-4 0z"/>
            </svg>
          </button>
        </div>
      </div>

      <!-- Messages wrapper with subtle light pattern -->
      <div class="relative flex-1 overflow-hidden bg-[#efeae2]">
        <div class="absolute inset-0 opacity-[0.08]"
             style="
               background-image:
                 radial-gradient(circle at 20% 30%, #000 0 1px, transparent 1px),
                 radial-gradient(circle at 70% 60%, #000 0 1px, transparent 1px);
               background-size: 70px 70px;
             "></div>

        <div id="chatMessages"
             class="relative h-full overflow-y-auto px-6 py-4 space-y-2">
          <!-- messages injected -->
        </div>

        <!-- Empty state -->
        <div id="chatEmptyState"
             class="absolute inset-0 flex items-center justify-center p-8">
          <div class="max-w-sm text-center text-gray-700">
            <div class="mx-auto mb-4 h-14 w-14 rounded-full bg-white/70 shadow-sm flex items-center justify-center">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7 text-gray-500" viewBox="0 0 20 20" fill="currentColor">
                <path d="M2 5a3 3 0 013-3h10a3 3 0 013 3v6a3 3 0 01-3 3H9l-4 3v-3H5a3 3 0 01-3-3V5z" />
              </svg>
            </div>
            <div class="font-semibold">Choose a chat</div>
            <div class="mt-1 text-xs text-gray-500">Pick a conversation on the left to start messaging.</div>
          </div>
        </div>
      </div>

      <!-- Composer -->
      <form id="chatForm"
            onsubmit="sendMessage(event)"
            class="px-4 py-3 bg-white border-t border-gray-100 flex items-center gap-3 relative z-10">

        <button type="button"
                class="h-10 w-10 rounded-full hover:bg-gray-100 transition flex items-center justify-center group"
                aria-label="Share File">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-500 group-hover:text-gray-700 transition-colors" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13" />
          </svg>
        </button>

        <input id="chatInput"
               type="text"
               placeholder="Select a conversation to start typingâ€¦"
               autocomplete="off"
               class="flex-1 bg-gray-100 rounded-full px-5 py-2.5 text-[15px]
                      outline-none text-gray-800 placeholder:text-gray-500
                      focus:bg-white focus:ring-1 focus:ring-gray-300 focus:shadow-sm
                      transition-all disabled:opacity-60"
               disabled
               required />

        <button id="chatSendBtn"
                type="submit"
                class="h-10 w-10 rounded-full bg-[#00a884] hover:bg-[#019c7a]
                       transition-all flex items-center justify-center shadow-sm hover:shadow-md
                       disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:shadow-sm"
                disabled
                aria-label="Send Message">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-white ml-0.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5">
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
          </svg>
        </button>
      </form>
    </main>

  </div>
</div>

<script>
    // Bridge Django template variables to global JS variables
    window.CURRENT_USER_ID = "{{ request.user.id|escapejs }}";
</script>

<script src="{% static 'chat/js/chat.js' %}"></script>